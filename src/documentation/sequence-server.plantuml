@startuml DTLS_Server_Workflow
skinparam backgroundColor LightGrey
skinparam activity {
  StartColor YellowGreen
  EndColor Tomato
  BackgroundColor White
  ArrowColor Black
}
start

:Create UDP socket;
:Initialize WolfSSL;

if (Use PSK or Certificates?) then (PSK)
  :Set PSK identity and key;
else (Certificates)
  :Load Root CA;
  : Load server certificate and key;
endif

if (Use CID?) then (yes)
  :Generate random CID;
  :Enable CID for session;
else (no)
  :Skip CID setup;
endif

:Perform DTLS handshake;
if (Handshake successful?) then (yes)
  while (Receiving packet)
    :Inspect packet;
    if (IP or port changed?) then (yes)
      if (CID enabled?) then (yes)
        :Verify received CID matches stored CID;
        if (CID matches?) then (yes)
          :Update DTLS context for new peer;
        else (no)
          :Terminate session and reset handshake;
          stop
        endif
      else (no)
        :Terminate session due to IP/port change;
        stop
      endif
    endif

    :Read data using WolfSSL;
    :Parse received CoAP message;

    if (CoAP message is confirmable?) then (yes)
      :Extract Message ID and Token;
      :Construct and send CoAP acknowledgment;
    else (no)
      :Handle non-confirmable CoAP message;
    endif
  endwhile
else (no)
  :Log handshake failure;
endif

:Cleanup DTLS session and resources;
stop
@enduml
